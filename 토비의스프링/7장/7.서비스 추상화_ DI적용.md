## ğŸª” ì„œë¹„ìŠ¤ ì¶”ìƒí™” ì ìš©

> ìë°”ì—ëŠ” JAXB ì™¸ì—ë„ ë‹¤ì–‘í•œ XMLê³¼ ìë°”ì˜¤ë¸Œì íŠ¸ë¥¼ ë§¤í•‘í•˜ëŠ” ê¸°ìˆ ì´ ìˆë‹¤. í•„ìš”ì— ë”°ë¼ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ì†ì‰½ê²Œ ë°”ê¿”ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì•¼ í•œë‹¤.
> XML íŒŒì¼ì„ ì¢€ ë” ë‹¤ì–‘í•œ ì†ŒìŠ¤ì— ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ ë§Œë“ ë‹¤.


### â˜‘ OXM(Object-XML-Mapping) ì„œë¹„ìŠ¤ ì¶”ìƒí™” 

> 1. OXM ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤
> 2. JAXB êµ¬í˜„ í…ŒìŠ¤íŠ¸ 
> 3. Castor êµ¬í˜„ í…ŒìŠ¤íŠ¸ 



JAXB ì™¸ì— ì‹¤ì „ì— ìì£¼ ì‚¬ìš©ë˜ëŠ” XMLê³¼ ìë°”ì˜¤ë¸Œì íŠ¸ ë§¤í•‘ ê¸°ìˆ . 

- 1) Castor XML 
- 2) JiBx
- 3) XmlBeans
- 4) Xstream

" OXM í”„ë ˆì„ì›Œí¬ì™€ ê¸°ìˆ ë“¤ì€ ê¸°ëŠ¥ ë©´ì—ì„œ ìƒí˜¸ í˜¸í™˜ì„±ì´ ìˆë‹¤. JAXBë¥¼ í¬í•¨í•´ì„œ ë‹¤ì„¯ ê°€ì§€ ê¸°ìˆ  ëª¨ë‘ ì‚¬ìš© ëª©ì ì´ ë™ì¼í•˜ê¸° ë•Œë¬¸ì— ìœ ì‚¬í•œ ê¸°ëŠ¥ê³¼ API ë¥¼ ì œê³µí•œë‹¤. "

<br>

âœğŸ» ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜, ë©”ì¼ ì „ì†¡ë¿ ì•„ë‹ˆë¼ OXM ì— ëŒ€í•´ì„œë„ ì„œë¹„ìŠ¤ ì¶”ìƒí™” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. 
<br> ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” OXM ì¶”ìƒ ê³„ì¸µì˜ APIë¥¼ ì´ìš©í•´ XML ë¬¸ì„œì™€ ì˜¤ë¸Œì íŠ¸ ì‚¬ì´ì˜ ë³€í™˜ì„ ì²˜ë¦¬í•˜ê²Œ í•˜ë©´, ì½”ë“œ ìˆ˜ì • ì—†ì´ë„ OXM ê¸°ìˆ ì„ ììœ ë¡­ê²Œ ë°”ê¿”ì„œ ì ìš©í•  ìˆ˜ ìˆë‹¤.

### 1. OXM ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤

: ìë°” ì˜¤ë¸Œì íŠ¸ë¥¼ xmlë¡œ ë³€í™˜í•˜ëŠ” Marshallerì™€, ë°˜ëŒ€ë¡œ XMLì„ ìë°”ì˜¤ë¸Œì íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” Unmarshallerì´ ìˆë‹¤.

##### Unmarshaller ì¸í„°í˜ì´ìŠ¤

```java
package org.springframework.oxm;
...
import java.xml.transform.Source; 

public interface Unmarshaller {
    boolean supports(Class<?> clazz);   // í•´ë‹¹ í´ë˜ìŠ¤ë¡œ ì–¸ë§ˆìƒ¬ì´ ê°€ëŠ¥í•œì§€ í™•ì¸í•´ì¤€ë‹¤.ë³„ë¡œ ì‚¬ìš©í•  ì¼ì€ ì—†ë‹¤.
    
    Object unmarshal(Source source) throws IOException, XmlMappingException; 
}
```
" Unmarshaller ì¸í„°í˜ì´ìŠ¤ <br> : XML íŒŒì¼ì— ëŒ€í•œ ì •ë³´ë¥¼ ë‹´ì€ Source íƒ€ì…ì˜ ì˜¤ë¸Œì íŠ¸ë¥¼ ì£¼ë©´, ì„¤ì •ì—ì„œ ì§€ì •í•œ OXM ê¸°ìˆ ì„ ì´ìš©í•´ ìë°” ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ë¡œ ë³€í™˜í•˜ê³ , ë£¨íŠ¸ ì˜¤ë¸Œì íŠ¸ë¡œ ëŒë ¤ì¤€ë‹¤. 
"

<br>

### 2. JAXB êµ¬í˜„ í…ŒìŠ¤íŠ¸ 

: JAXBë¥¼ ì´ìš©í•˜ë„ë¡ ë§Œë“¤ì–´ì§„ Unmarshaller êµ¬í˜„ í´ë˜ìŠ¤ëŠ” Jaxb2Marshallerì´ë‹¤. <br>
( Jaxb2Marshaller í´ë˜ìŠ¤ëŠ” Unmarshaller ì¸í„°í˜ì´ìŠ¤ì™€ Marshaller ì¸í„°í˜ì´ìŠ¤ë¥¼ ëª¨ë‘ êµ¬í˜„í•˜ê¸° ìˆë‹¤.) 

##### JAXBìš© Unmarshaller ë¹ˆ ì„¤ì •. 

```java
<? xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

    <bean id="unmarshaller" class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
        <property name="contextPath" value="springbook.user.sqlservice.jaxb" />
    </bean>
</beans>
```

##### OXM ì–¸ë§ˆìƒ¬ë§ í…ŒìŠ¤íŠ¸ ì½”ë“œ 

```JAVA
package springbook.learningtest.spring.oxm;
...
import org.springframework.oxm.Unmarshaller;  // JAXB API ë“±ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì–¸ë§ˆìƒ¬ëŸ¬ì™€ í´ë˜ìŠ¤ ì´ë¦„ì´ ê°™ìœ¼ë¯€ë¡œ ì„í¬íŠ¸í•  ë•Œ ì£¼ì˜í•´ì•¼ í•œë‹¤.
import javax.xml.transform.stream.StreamSource; 

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration
public class OxmTest { 

    @Autowired Unmarshaller unmarshaller; 
    
    @Test
    public void unmarshallSqlMap() throws XmlMappingException, IOException {
    
        Source xmlSource = new StreamSource(
              getClass().getResourceAsStream("sqlmap.xml"));
              
        Sqlmap sqlmap = (Sqlmap) this.unmarshaller.unmarshal(xmlSource); 
        
        List<SqlType> sqlList = sqlmap.getSql();
        
        List<SqlType> sqlList = sqlmap.getSql();
        assertThat(sqlList.size(), is(3));
        assertThat(sqlList.get(0).getKey(), is("add"));
        
        ...
        assertThat(sqlList.get(2).getValue(), is("delete"));
    }
}
```

" ìœ„ í…ŒìŠ¤íŠ¸ìš© ì½”ë“œëŠ” OXM ì¶”ìƒí™” ê³„ì¸µì„ ì´ìš©í–ˆë‹¤. ë”°ë¼ì„œ JAXBë¼ëŠ” ê¸°ìˆ ì— ì˜ì¡´í•˜ëŠ” ë¶€ë¶„ì€ ì‚¬ë¼ì¡Œë‹¤. "

### 3. Castor êµ¬í˜„ í…ŒìŠ¤íŠ¸ 

: ë§¤í•‘ì •ë³´ë§Œ ì ì ˆíˆ ë§Œë“¤ì–´ì£¼ë©´ ì–´ë–¤ í´ë˜ìŠ¤ì™€ í•„ë“œë¡œë„ ë§¤í•‘ì´ ê°€ëŠ¥í•˜ë‹¤. 

##### Castorìš© ë§¤í•‘ì •ë³´

```java
<?xml version="1.0"?>
<!DOCTYPE mapping PUBLIC "-//EXOLAB/Castor Mapping DTD Version 1.0/EN" 
        "http://castor.org/mapping.dtd">
<mapping>
    <class name="springbook.sqlservice.jaxb.Sqlmap">
        <map-to xml="sqlmap" />
        <field name="sql" type="springbook.sqlservice.jaxb.SqlType"
               required="true" collection="arraylist">
            <bind-xml name="sql" node="element" />
        </field>    
    </class>
    <class name="springbook.sqlservice.jaxb.SqlType">
        <map-to xml="sql" />
        <field name="key" type="string" required="true">
            <bind-xml name="key" node="attribute" />
        </field>
        <field name="value" type="string" required="true">
            <bind-xml node="text" />
        </field>
    </class>

</mapping>
```

##### Castor ê¸°ìˆ ì„ ì‚¬ìš©í•˜ëŠ” ì–¸ë§ˆìƒ¬ëŸ¬ ì„¤ì •.

: ummarshaller ë¹ˆì˜ í´ë˜ìŠ¤ë¥¼ Castorìš© êµ¬í˜„ í´ë˜ìŠ¤ë¡œ ë³€ê²½í•œë‹¤.

```java
<bean id="unmarshaller"
       class="org.springframework.oxm.castor.CastorMarshaller">
   <property name="mappingLocation"
            value="springbook/learningtest/spring/oxm/mapping.xml" />
</bean>
```

" ìœ„ì— ê²°ê³¼ë¥¼ í…ŒìŠ¤íŠ¸ í•´ë³´ë©´ í…ŒìŠ¤íŠ¸ ë‚´ì˜ ì–¸ë§ˆìƒ¬ëŸ¬ë¥¼ ì´ìš©í•˜ëŠ” ì½”ë“œëŠ” ì „í˜€ ë°”ë€Œì§€ ì•Šì•˜ì§€ë§Œ xml íŒŒì¼ì„ ì½ì–´ì„œ ë³€í™˜í•˜ëŠ” ê¸°ìˆ ì€ Castorë¡œ ì™„ë²½í•˜ê²Œ ì „í™˜ëë‹¤.  <br>

ì„œë¹„ìŠ¤ ì¶”ìƒí™”ëŠ” ì´ë ‡ê²Œ ë¡œìš°ë ˆë²¨ì˜ ê¸°ìˆ ì„ í•„ìš”ì— ë”°ë¼ ë³€ê²½í•´ì„œ ì‚¬ìš©í•˜ë”ë¼ë„ ì¼ê´€ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë¥¼ ìœ ì§€í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤."

<br>

### â˜‘ OXM ì„œë¹„ìŠ¤ ì¶”ìƒí™” ì ìš© 

: ìŠ¤í”„ë§ì˜ OXM ì¶”ìƒí™” ê¸°ëŠ¥ì„ ì´ìš©í•˜ëŠ” SqlServiceë¥¼ ë§Œë“¤ì–´ë³´ì."

> 1. ë©¤ë²„ í´ë˜ìŠ¤ë¥¼ ì°¸ì¡°í•˜ëŠ” í†µí•© í´ë˜ìŠ¤
> 2. OXM ì„œë¹„ìŠ¤ ì¶”ìƒí™” ì ìš©
> 3. ìœ„ì„ì„ ì´ìš©í•œ BaseSqlService ì˜ ì¬ì‚¬ìš©

<br>

### 1. ë©¤ë²„ í´ë˜ìŠ¤ë¥¼ ì°¸ì¡°í•˜ëŠ” í†µí•© í´ë˜ìŠ¤ 

: OxmSqlServiceëŠ” BaseSqlService ì™€ ìœ ì‚¬í•˜ê²Œ SqlReader íƒ€ì…ì˜ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ë˜ ì´ë¥¼ ìŠ¤íƒœí‹± ë©¤ë²„ í´ë˜ìŠ¤ë¡œ ë‚´ì¥í•˜ê³  ìì‹ ë§Œì´ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ ë³´ì. 

##### OxmSqlService ê¸°ë³¸ êµ¬ì¡°

```java
package springbook.user.sqlservice; 

public class OxmSqlService implements SqlService {
    private final OxmSqlReader oxmSqlReader = new OxmSqlReader(); 
    ...
    
    private class OxmSqlReader implements SqlReader {
      ...
    }
}

```

âœğŸ» OxmsqlReader ëŠ” private ë©¤ë²„ í´ë˜ìŠ¤ì´ë¯€ë¡œ ì™¸ë¶€ì— ì ‘ê·¼í•˜ê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.<br>
ë˜í•œ OxmSqlService ëŠ” ì´ë¥¼ final ë¡œ ì„ ì–¸í•˜ê³  ì§ì ‘ ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— OxmSqlReaderë¥¼ DI í•˜ê±°ë‚˜ ë³€ê²½í•  ìˆ˜ ì—†ë‹¤. <br>

ë””í´íŠ¸ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ë°©ì‹ì˜ í•œê³„ëŠ” ë””í´íŠ¸ë¡œ ë‚´ë¶€ì—ì„œ ë§Œë“œëŠ” ì˜¤ë¸Œì íŠ¸ì˜ í”„ë¡œí¼í‹°ë¥¼ ì™¸ë¶€ì—ì„œ ì§€ì •í•´ì£¼ê¸°ê°€ í˜ë“¤ë‹¤ëŠ” ì ì´ë‹¤. 

##### ë‚´ë¶€ ì˜¤ë¸Œì íŠ¸ì˜ í”„ë¡œí¼í‹°ë¥¼ ì „ë‹¬í•´ì£¼ëŠ” ì½”ë“œ

: OxmSqlService ì˜ í”„ë¡œí¼í‹°ë¥¼ í†µí•´ ë‚´ì¥ëœ ë©¤ë²„ í´ë˜ìŠ¤ì˜ í”„ë¡œí¼í‹°ë¥¼ ì„¤ì •í•´ì£¼ëŠ” ì½”ë“œë‹¤. 

```java
public class OxmSqlService implements SqlService {
    private final OxmSqlReader oxmSqlReader = new OxmSqlReader();
    ...
    public void setUnmarshaller(Unmarshaller unmarshaller){
        this.oxmSqlReader.setUnmarshaller(unmarshaller);
    }
    
    public void setUnmarshaller(Unmarshaller unmarshaller){
        this.oxmSqlReader.setSqlmapFile(sqlmapFile);
    }
    ...
    
    private class OxmSqlReader implements SqlReader {
        private Unmarshaller unmarshaller; 
        private String sqlmapFile; 
        // setter ë©”ì†Œë“œ ìƒëµ
        ...
    }
}
```

##### ì™„ì„±ëœ OxmSqlService í´ë˜ìŠ¤

: ì™„ì„±ëœ OxmSqlService í´ë˜ìŠ¤ë‹¤. 

```java
public class OxmSqlService implements SqlService {
    private final OxmSqlReader oxmSqlReader = new OxmSqlReader(); 
    
    private SqlRegistry sqlRegistry = new HashMapSqlRegistry();
    
    public void setSqlRegistry(SqlRegistry sqlRegistry){
        this.sqlRegistry = sqlRegistry; 
    }
    
    public void setUnmarshaller(Unmarshaller unmarshaller { ... }
    public void setSqlmapFile(String sqlmapFile) { ... }
    
    
    @PostConstruct
    public void loadSql() { this.oxmSqlReader.read(this.sqlRegistry); }
    
    public String getSql(String key) throws SqlRetrievalFailureException {
        try { 
            return this.sqlRegistry.findSql(key); 
            
        } catch (SqlNotFoundException e){
            throw new SqlRetrievalFailureException(e); 
        }
    }
    
    
    private class OxmSqlReader implements SqlReader {
    
        private Unmarshaller unmarshaller; 
        private final static String DEFAULT_SQLMAP_FILE = "sqlmap.xml";
        private String sqlmapFile = DEFAULT_SQLMAP_FILE;
        
        
        public void setUnmarshaller(Unmarshaller unmarshaller){
            this.unmarshaller = unmarshaller; 
        
        }
    
        public void setSqlmapFile(String sqlmapFile) { this. sqlmapFile = sqlmapFile; }
    
    
        public void read(SqlRegistry sqlRegistry{
            try { 
               Source source = new StreamSource( 
                        UserDao.class.getResourceAsStream(this.sqlmapFile));
               
               Sqlmap sqlmap = (Sqlmap) this.unmarshaller.unmarshal(source);
               
               for(SqlType sql : sqlmap.getSql()){
                    sqlRegistry.registerSql(sql.getKey(), sql.getValue());
    
               }            
            } catch (IOException e) {
                  throw new IllegalArgumentException(this.sqlmapFile + "ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", e);
            }        
        }
    }
}
```

##### OXMì„ ì ìš©í•œ SqlService ì„¤ì •. 

```java
<bean id="sqlService" class="springbook.user.sqlservice.OxmSqlSerivce">
    <property name="unmarshaller" ref="unmarshaller" />
</bean>
<bean>
    <property name="contextPath" value="springbook.user.sqlservice.jaxb" />
</bean>
``` 

<br>

### 3. ìœ„ì„ì„ ì´ìš©í•œ BaseSqlService ì˜ ì¬ì‚¬ìš©

##### BaseSqlService ë¡œì˜ ìœ„ì„ì„ ì ìš©í•œ OxmSqlService

```java
public class OxmSqlService implements SqlService { 
    private final BaseSqlService baseSqlService = new BaseSqlService(); 
    ...
    
    @PostConstruct
    public void loadSql(){
    
        this.baseSqlService.set
    
    }
    
    public String getSql(String key) throws SqlRetrievalFailureException {
        return this.baseSqlService.getSql(key);
    }
    


}
```


### ë¦¬ì†ŒìŠ¤ ì¶”ìƒí™”

> 1. ë¦¬ì†ŒìŠ¤ ë¡œë”
> 2. Resourceë¥¼ ì´ìš©í•´ XML íŒŒì¼ ê°€ì ¸ì˜¤ê¸° 




----

## ğŸª” ì¸í„°í˜ì´ìŠ¤ ìƒì†ì„ í†µí•œ ì•ˆì „í•œ ê¸°ëŠ¥í™•ì¥. 



### â˜‘ DI ê¸°ëŠ¥ì˜ í™•ì¥. 

- 1) DIë¥¼ ì˜ì‹í•˜ëŠ” ì„¤ê³„ 
- 2) DIì™€ ì¸í„°í˜ì´ìŠ¤ í”„ë¡œê·¸ë˜ë° 

### â˜‘ ì¸í„°í˜ì´ìŠ¤ ìƒì† 

----

## ğŸª” DIë¥¼ ì´ìš©í•´ ë‹¤ì–‘í•œ êµ¬í˜„ ë°©ë²• ì ìš©í•˜ê¸° 

### â˜‘ ConcurrentHashMapì„ ì´ìš©í•œ ìˆ˜ì • ê¸°ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ 

> 1. ìˆ˜ì • ê¸°ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸ 
> 2. ìˆ˜ì • ê¸°ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬í˜„ 

### â˜‘ ë‚´ì¥í˜• DBë¥¼ ì´ìš©í•œ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë§Œë“¤ê¸°. 

> 1. ìŠ¤í”„ë§ì˜ ë‚´ì¥í˜• DB ì§€ì› ê¸°ëŠ¥. 
> 2. ë‚´ì¥í˜• DB ë¹Œë” í•™ìŠµ í…ŒìŠ¤íŠ¸ 
> 3. ë‚´ì¥í˜• DBë¥¼ ì´ìš©í•œ SqlRegistry ë§Œë“¤ê¸°
> 4. UpdatableSqlRegustry í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ ì¬ì‚¬ìš©
> 5. XML ì„¤ì •ì„ í†µí•œ ë‚´ì¥í˜• DBì˜ ìƒì„±ê³¼ ì ìš© 


### â˜‘ íŠ¸ëœì­ì…˜ ì ìš©

> 1. ë‹¤ì¤‘ SQL ìˆ˜ì •ì— ëŒ€í•œ íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ 
> 2. ì½”ë“œë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ì ìš©


<br><br>

