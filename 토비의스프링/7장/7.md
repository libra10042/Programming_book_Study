# 스프링 핵심 기술의 응용

## SQL 과 DAO 의 분리 

> 1) XML 설정을 이용한 분리 
> - 개별 SQL프로퍼티 방식
> - SQL 맵 프로퍼티 방식. 
> <br>
> 2) Refactoring
> - SQL 제공서비스를 이용하는 방식. 
> - 스프링 설정을 사용하는 단순 SQL 

##### 개별 SQL 프로퍼티 방식. 

```JAVA
public class UserDaoJdbc implements UserDao {
    private String sqlAdd; 
    
    public void setSqlAdd(String sqlAdd){
        this.sqlAdd = sqlAdd;
    }
      
```

```JAVA
public void add(User user) {
    this.jdbcTemplate.update(
        this.sqlAdd, 
        user.getId(), user.getName(), user.getPassword(), user.getEmail(),
        user.getLevel().intValue(), user.getLogin(), user.getRecommand());
}
```

```JAVA
<bean id="userDao" class="springboot.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlAdd" value="insert into users(id, name, password, 
        email, level, login, recommand)  values(?,?,?,?,?,?,?)" />
```

##### SQL 맵 프로퍼티 방식. 

: UserDao에서 SQL을 주입받기 위해 개별적으로 정의한 프로퍼티를 모두 제거하자. <br>그리고 Map 타입의 sqlMap을 대신 추가한다.

```java
public class UserDaoJdbc implements UserDao{

    private Map<String, String> sqlMap;
    
    public void setSqlMap(Map<String, String> sqlMap){
        this.sqlMap = sqlMap;
    }
}
```

```java
public void add(User user){
    this.jdbcTemplate.update(
        this.sqlMap.get("add"),
        user.getId(), user.getName(), user.getPassword(), user.getEmail(), 
        user.getLevel().intValue(), user.getLogin(), user.getRecommand());
    )
```

```java
<bean id="uerDao" class="springbook.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlMap">
         <map>    
              <entry key="add" value="insert into users(id, name, password, email, level, login, recommend)
                                      valuse(?,?,?,?,?,?,?)" />
              <entry key="get" value="select * from users where id=?" />
              <entry key="getAll" value="select * from users order by id" />
              <entry key="deleteAll" value="delete from users" />
              <entry key="getCount" value="select count(*) from users" />
              <entry key="update" value="update users set name = ?, password = ?, email = ?, level =?, 
                                          login = ?, recommand = ? where id = ?" />
         </map>
    </property>
</bean>
```

" sql 맵 프로퍼티 방식은 해당 메소드가 실행되기 전에는 오류를 확인하기 힘들다는 단점이 있다. "

<br>

### SQL 제공 서비스를 이용한 방식. 

##### SqlService 인터페이스

```java
public interface SqlService{
     String getSql(String key) throws SqlRetrievalFailureException;

}
```

* SqlRetrievalFailureException : 이 예외는 복구가 불가능하므로 런타임 예외로 정의해 둔다.

##### SQL 조회 실패 시 예외

```java
public class SqlRetrievalFailureException extends RuntimeException {
     public SqlRetrievalFailureException(String message){
        super(message);
     }
     
     public SqlRetrievalFailureException(String message, Throwable cause){
        super(message, cause);
     }
}
```

##### SqlService 프로퍼티 추가. 

```java
public class UserDaoJdbc implements UserDao{
    private SqlService sqlService; 
    
    public void setSqlService(SqlService sqlService){
        this.sqlService = sqlService; 
    }
}
```

##### sqlService 를 사용하도록 수정한 메소드

```java
public void add(User user){
    this.jdbcTemplate.update(this.sqlService.getSql("userAdd"),
          user.getId(), user.getName(), user.getPassword(), user.getEmail(), 
          user.getLevel().intValue(), user.getLogin(), user.getRecommand());
}
    
public User get(String id){
    return this.jdbcTemplate.queryForObject(this.sqlService.getSql("userGet"),
        new Object[] {id}, this.userMapper);
}
   
public List<User> getAll(){
    return this.jdbcTemplate.query(this.sqlService.getSql("userGetAll"),
          this.userMapper);
}

public int getCount(){
    return this.jdbcTemplate.queryForInt(this.sqlService.getSql("userGetCount"));
}

public void update(User user){
    this.jdbcTemplate.update(this.sqlService.getSql("userUpdate"),
        user.getName(), user.getPassword(), user.getEmail(), 
        user.getLevel().intValue(), user.getLogin(), user.getRecommand(), 
        user.getId()); 
}

```


##### 스프링 설정을 사용하는 단순 SQL 서비스

```java

public class SimpleService implements SqlService{
    private Map<String, String> sqlMap;
    
    public void setSqlMap<String, String> sqlMap){
        this.sqlMap = sqlMap; 
    }
    
    
    public String getSql(String key) throws SqlRetrievalFailureException {
        String sql = sqlMap.get(key);
        
        if(sql == null)
            throw new SqlRetrievalFailureException( key + "에 대한 SQL을 찾을 수 없습니다");
        else {
            return sql; 
    }
}
```

```java
<bean id="userDao" class="springbook.dao.userDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlService" ref="sqlService" />
</bean>

<bean id="sqlService" class="springbook.user.sqlservice.SimpleSqlService">
    <property name"sqlMap">
        <map>
            <entry key="userAdd" value="insert into user(id, name, password, email, level, login, recomned) values(?, ?, ?, ?, ?, ?, ?)" />
            <entry key="userGet" value="select * from users where id = ?" />
            <entry key="userGetAll" value="select * from users order by id" />
            <entry key="userDeleteAll" value="delete from users" />
            <entry key="userGetCount" value="select count(*) from users" />
            <entry key="userUpdate" value="update users set name = ?, password = ?, email = ?, level = ?, login = ?, recommand = ? where id = ?" />
        </map>
    </property>
</bean>
```

