# 트랜잭션 서비스 추상화 
--- 
#### UserService의 테스트용 대역 클래스
```
static Class TestUserService extends UserService { 
    private String id; 
    
    private TestUserService(String id){
        this.id = id;       
    }

    protected void upgradedLevel(User user){          
        if(user.getId().equals(this.id)) throw new TestUserServiceException();
        super.upgradeLevel(user);
    }

}
```

```
statis class TestUserServiceException extends RuntimeException {
}
```
<br>

## 강제예외발생을 통한 테스트

##### 예외 발생 시 작업 취소 여부 테스트
```
@Test
public void upgradeAllOrNoting(){
    userservice testUserService = new TestUserService(users.get(3).getId());
    testUserService.setUserDao(this.userDao); 
    userDao.deleteAll();
    for(User user : users) userDao.add(user);
    
    try {
        testUserService.upgradeLevels();
        fail("TestUserServiceException expected");
    
    }catch(TestUserServiceException e){
    
    }
    checkLevelUpgraded(users.get(1), false); 
}
```
<br>
<br>

#### 트랜잭션 경계설정

```
여러 개의 SQL이 사용되는 작업을 하나의 트랜잭션으로 취급해야 하는 경우도 있다. ex) 은행 입출금. 
복잡한 로직의 흐름 사이에서 정확하게 트랜잭션 경계를 설정하는 일은 매우 중요한 작업이다.
commit 또는 rollback()으로 트랜잭션을 종료하는 작업을 트랜잭션의 경계설정이라고 한다.
```

#### 트랜잭션 동기화 
```
멀티스레드 환경에서도 안전한 트랜잭션 동기화 방법을 구현하는 일이 기술적으로 간단하지 않다. 다행이 스프링 jdbcTempalte과 더불어 이런 트랜잭션 동기화 기능을
지원하는 간단한 유틸리티 메소드를 제공하고 있다.
```
##### 트랜잭션 동기화 방식을 적용한 UserService

> 트랜잭션 동기화 관리 클래스는 TransactionSychronizationManager다. 이 클래스를 이용해 먼저 트랜잭션 동기화 작업을 초기화하도록 요청한다.
```
pirvate DataSource dataSoure;

public void setDataSource(DataSource dataSource){
    this.dataSource = dataSource; 
}

public void upgradeLevels() throws Exception { 
    TransactionSynchronizationMapper.initSynchronization();     // 트랜잭션 동기화 관리자를 이용해 동기화 작업을 초기화 한다.
    
    Connection c = DataSourceUtils.getConnection(dataSource);   // DB 커넥션을 생성하고 트랜잭션을 시작한다.이후의 DAO 작업은 모두 여기서 시작한 트랜잭션 안에서 진행된다.
    c.setAutoCommit(false);
    
    try { 
        List<User> user = userDao.getAll(); 
        for(User user : users) {
            if(canUpgradeLevel(user)){
                upgradeLevel(user);
            }
        
        }
        c.commit();    // 정상적으로 작업을 마치면 트랜잭션 커밋.
    
    
    }catch(Exception e){
        c.rollback();
        throw e;; 

    }finally { 
        DataSourceUtils.releaseConnection(c, dataSource);           // 스프링 유틸리티 메소드를 이용해 DB 커넥션을 안전하게 닫는다. 
        TransactionSynchronizationManager.unbindResource(this.dataSource); 
        TransactionSynchronizationManger.clearSynchronization();          
    
    |
    
}


```
##### 트랜잭션 서비스 추상화 
> 자바는 JDBC 외에 이런 글로벌 트랜잭션을 지원하는 트랜잭션 매니저를 지원하기 위한 API 인 JTA를 제공하고 있다.
